name: Deploy Spring Boot App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
     
    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'
     
    - name: Build project with Maven
      run: mvn clean package -DskipTests
     
    - name: Upload JAR to server via SCP
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "target/products-0.0.1-SNAPSHOT.jar"
        target: "${{ secrets.DEPLOY_DIR }}"
         
   - name: Restart Spring Boot app on server
  uses: appleboy/ssh-action@v1.0.0
  with:
    host: ${{ secrets.SSH_HOST }}
    username: ${{ secrets.SSH_USER }}
    key: ${{ secrets.SSH_PRIVATE_KEY }}
    script: |
      echo "‚úÖ Starting deployment process..."
      
      # Check if JAR exists
      JAR_PATH="${{ secrets.DEPLOY_DIR }}/target/products-0.0.1-SNAPSHOT.jar"
      if [ ! -f "$JAR_PATH" ]; then
        echo "‚ùå JAR file not found at: $JAR_PATH"
        exit 1
      fi
      
      echo "‚úÖ JAR file found at: $JAR_PATH"
      
      # Stop existing process
      echo "üîÑ Stopping existing Java processes..."
      pkill -f 'products-0.0.1-SNAPSHOT.jar' || true
      sleep 3
      
      # Start new process with proper detachment
      echo "üöÄ Starting new application..."
      cd ${{ secrets.DEPLOY_DIR }}
      
      # Method 1: Use screen (if available)
      if command -v screen >/dev/null 2>&1; then
        screen -dmS spring-app java -jar target/products-0.0.1-SNAPSHOT.jar
        echo "‚úÖ Application started in screen session"
      else
        # Method 2: Use nohup with explicit redirection and disown
        nohup java -jar target/products-0.0.1-SNAPSHOT.jar > app.log 2>&1 < /dev/null &
        JAVA_PID=$!
        disown $JAVA_PID
        echo "‚úÖ Application started with PID: $JAVA_PID"
      fi
      
      # Give it a moment to start
      sleep 3
      
      # Verify it's running
      if pgrep -f 'products-0.0.1-SNAPSHOT.jar' > /dev/null; then
        echo "‚úÖ Application is running successfully!"
        pgrep -f 'products-0.0.1-SNAPSHOT.jar'
      else
        echo "‚ùå Application may not have started properly"
        echo "Checking log file..."
        if [ -f app.log ]; then
          tail -n 20 app.log
        fi
      fi